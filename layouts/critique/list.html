{{ define "main" }}

<link rel="stylesheet" href="/css/bio-pages.css">
<link rel="stylesheet" href="/css/press.css">
<link rel="stylesheet" href="/css/writing.css"> {{/* one-column overrides that mimic press visuals */}}

{{/* language only for item-level BG/EN fallbacks */}}
{{ $isBG := eq .Site.Language.Lang "bg" }}

{{/* load + filter (hide noshow true/"true") */}}
{{ $all := site.Data.critique | default (slice) }}
{{ $all = where $all "noshow" "ne" true }}
{{ $all = where $all "noshow" "ne" "true" }}

{{/* split + sort like Press */}}
{{ $withYear := where $all "year" "!=" "" | default (slice) }}
{{ $withYear = where $withYear "year" "ne" nil }}
{{ $sorted := sort $withYear "year" "desc" }}
{{ $older  := append (where $all "year" "") (where $all "year" nil) }}

{{/* -------- JSON-LD data (built safely, no trailing commas) -------- */}}
{{ $personName := or .Site.Language.Params.name .Site.Params.name }}
{{ $personImg  := or .Site.Language.Params.profileImage .Site.Params.profileImage }}

{{/* Build Person/about */}}
{{ $about := dict "@type" "Person" "name" $personName "url" .Site.BaseURL }}
{{ with $personImg }}
  {{ $about = merge $about (dict "image" (. | absURL)) }}
{{ end }}

{{/* Build ItemList.itemListElement */}}
{{ $elems := slice }}
{{ range $i, $it := $all }}
  {{ $title := cond $isBG (or $it.namebg $it.nameen) (or $it.nameen $it.namebg) }}
  {{ $desc  := cond $isBG (or $it.descriptionbg $it.descriptionen) (or $it.descriptionen $it.descriptionbg) }}
  {{ $auth  := cond $isBG (or $it.authorbg $it.authoren) (or $it.authoren $it.authorbg) }}

  {{ $article := dict "@type" "Article" "headline" $title "url" $it.url }}
  {{ with $desc  }} {{ $article = merge $article (dict "description" .) }} {{ end }}
  {{ with $auth  }} {{ $article = merge $article (dict "author" (dict "@type" "Person" "name" .)) }} {{ end }}
  {{ with $it.year }} {{ $article = merge $article (dict "datePublished" (printf "%v" .)) }} {{ end }}
  {{ with $it.exhibition }} {{ $article = merge $article (dict "isPartOf" .) }} {{ end }}

  {{ $li := dict "@type" "ListItem" "position" (add $i 1) "item" $article }}
  {{ $elems = $elems | append $li }}
{{ end }}

<script type="application/ld+json">
{{ dict
  "@context" "https://schema.org"
  "@type" "WebPage"
  "url" .Permalink
  "name" (i18n "critique" | default "Critique")
  "inLanguage" .Site.Language.Lang
  "about" $about
  "mainEntity" (dict "@type" "ItemList" "itemListElement" $elems)
| jsonify }}
</script>

<div class="biolist">
  <h1 class="page-heading">{{ i18n "critique" }}</h1>

  <div class="about-wrap container--writing">
    <section class="about-body">
      <ul class="writing-list" role="list">
        {{/* Year-grouped visible items (single column, press look) */}}
        {{ $current := 0 }}
        {{ range $sorted }}
          {{ if ne $current .year }}
            {{ $current = .year }}
            <li class="press-year">{{ $current }}</li>
          {{ end }}

          {{ $title := cond $isBG (or .namebg .nameen) (or .nameen .namebg) }}
          {{ $desc  := cond $isBG (or .descriptionbg .descriptionen) (or .descriptionen .descriptionbg) }}
          {{ $auth  := cond $isBG (or .authorbg .authoren) (or .authoren .authorbg) }}

          <li class="press-item">
            <h2 class="press-titleline">
              <a class="press-link" href="{{ .url }}" target="_blank" rel="noopener noreferrer">{{ $title }}</a>
            </h2>
            {{ with $auth }}<div class="press-author">{{ . }}</div>{{ end }}
            {{ with $desc }}<div class="press-desc">{{ . }}</div>{{ end }}
          </li>
        {{ end }}

        {{ if gt (len $older) 0 }}
          <li class="press-year press-year-older">{{ i18n "earlier" }}</li>
          {{ range $older }}
            {{ $title := cond $isBG (or .namebg .nameen) (or .nameen .namebg) }}
            {{ $desc  := cond $isBG (or .descriptionbg .descriptionen) (or .descriptionen .descriptionbg) }}
            {{ $auth  := cond $isBG (or .authorbg .authoren) (or .authoren .authorbg) }}

            <li class="press-item">
              <h2 class="press-titleline">
                <a class="press-link" href="{{ .url }}" target="_blank" rel="noopener noreferrer">{{ $title }}</a>
              </h2>
              {{ with $auth }}<div class="press-author">{{ . }}</div>{{ end }}
              {{ with $desc }}<div class="press-desc">{{ . }}</div>{{ end }}
            </li>
          {{ end }}
        {{ end }}
      </ul>
    </section>
  </div>
</div>

{{ end }}
