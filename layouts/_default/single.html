<!-- JSON-LD: WebPage + Event + Person + Images + Breadcrumbs -->
<script type="application/ld+json">
  {{- /* Person (Nikola) */ -}}
  {{- $personName   := or .Site.Language.Params.name .Site.Params.name -}}
  {{- $altName      := or .Site.Language.Params.alternateName .Site.Params.alternateName -}}
  {{- $jobTitle     := or .Site.Language.Params.jobTitle .Site.Params.jobTitle -}}
  {{- $profileImage := or .Site.Language.Params.profileImage .Site.Params.profileImage -}}
  {{- if $profileImage }}{{ $profileImage = $profileImage | absURL }}{{ end -}}
  
  {{- /* sameAs from socials + other */ -}}
  {{- $sameAs := slice -}}
  {{- with .Site.Params.social.instagram }}{{ $sameAs = $sameAs | append . }}{{ end -}}
  {{- with .Site.Params.social.facebook  }}{{ $sameAs = $sameAs | append . }}{{ end -}}
  {{- with .Site.Params.social.youtube   }}{{ $sameAs = $sameAs | append . }}{{ end -}}
  {{- with .Site.Params.params_sameas_other -}}
    {{- range . }}{{ $sameAs = $sameAs | append . }}{{ end -}}
  {{- end -}}
  
  {{- $person := dict
    "@type" "Person"
    "@id"   (print .Site.BaseURL "#person")
    "name"  $personName
    "alternateName" $altName
    "jobTitle" $jobTitle
    "url"   .Site.BaseURL
    "nationality" "Bulgarian"
    "knowsLanguage" (slice "bg-BG" "en")
  -}}
  {{- if $profileImage }}{{ $person = merge $person (dict "image" $profileImage) }}{{ end -}}
  {{- if gt (len $sameAs) 0 }}{{ $person = merge $person (dict "sameAs" $sameAs) }}{{ end -}}
  
  {{- /* Dates */ -}}
  {{- $start := cond (isset .Params "datestart") (.Params.datestart | time.AsTime) nil -}}
  {{- $end   := cond (isset .Params "dateend")   (.Params.dateend   | time.AsTime) nil -}}
  
  {{- /* Location */ -}}
  {{- $addr := dict "@type" "PostalAddress" "addressCountry" "Bulgaria" -}}
  {{- with (or .Params.addressLocality .Params.location) -}}
    {{- $addr = merge $addr (dict "addressLocality" .) -}}
  {{- end -}}
  {{- $loc := dict "@type" "Place" "name" .Params.place "address" $addr -}}
  
  {{- /* Keywords from medium */ -}}
  {{- $keywords := "" -}}
  {{- with .Params.medium }}{{ $keywords = delimit . ", " }}{{ end -}}
  
  {{- /* ImageObjects + ID list for Event.image */ -}}
  {{- $imgNodes := slice -}}
  {{- $imgIDs   := slice -}}
  {{- range $i, $res := .Resources.Match "*.*" -}}
    {{- if and (in $res.MediaType.Type "image") (ne $res.Name "hero.webp") -}}
      {{- $title := index $.Params.imgNames   $i | default "" -}}
      {{- $desc  := index $.Params.imgDescrps $i | default "" -}}
      {{- $large := $res.Resize "1600x" -}}
      {{- $id    := print $large.Permalink "#img" -}}
      {{- $img   := dict
            "@type" "ImageObject"
            "@id"   $id
            "url"   $large.Permalink
            "contentUrl" $large.Permalink
            "name"  $title
            "caption" $desc
            "encodingFormat" $res.MediaType.String
         -}}
      {{- $imgNodes = $imgNodes | append $img -}}
      {{- $imgIDs   = $imgIDs   | append $id -}}
    {{- end -}}
  {{- end -}}
  {{- with .Resources.GetMatch "hero.webp" -}}
    {{- $imgNodes = $imgNodes | append (dict "@type" "ImageObject" "@id" (print .Permalink "#img") "url" .Permalink "contentUrl" .Permalink "name" "Hero" "encodingFormat" .MediaType.String) -}}
    {{- $imgIDs   = $imgIDs   | append (print .Permalink "#img") -}}
  {{- end -}}
  
  {{- /* Event */ -}}
  {{- $event := dict
    "@type" "Event"
    "@id"   (print .Permalink "#event")
    "name"  .Title
    "description" (default .Summary .Params.description)
    "eventStatus" "https://schema.org/EventScheduled"
    "eventAttendanceMode" "https://schema.org/OfflineEventAttendanceMode"
    "url" .Permalink
    "location" $loc
    "organizer" (dict "@id" (print .Site.BaseURL "#person"))
    "creator"   (dict "@id" (print .Site.BaseURL "#person"))
    "keywords"  $keywords
  -}}
  {{- if $start }}{{ $event = merge $event (dict "startDate" ($start | time.Format "2006-01-02T15:04:05Z07:00")) }}{{ end -}}
  {{- if $end   }}{{ $event = merge $event (dict "endDate"   ($end   | time.Format "2006-01-02T15:04:05Z07:00")) }}{{ end -}}
  {{- if gt (len $imgIDs) 0 }}{{ $event = merge $event (dict "image" $imgIDs) }}{{ end -}}
  
  {{- /* WebPage linking to Event */ -}}
  {{- $page := dict
    "@type" "WebPage"
    "@id"   (print .Permalink "#webpage")
    "url"   .Permalink
    "name"  .Title
    "inLanguage" .Site.Language.Lang
    "mainEntity" (dict "@id" (print .Permalink "#event"))
  -}}
  
  {{- /* Breadcrumbs */ -}}
  {{- $breadcrumbs := dict
    "@type" "BreadcrumbList"
    "@id"   (print .Permalink "#breadcrumbs")
    "itemListElement" (slice
      (dict "@type" "ListItem" "position" 1 "name" "Home"        "item" .Site.BaseURL)
      (dict "@type" "ListItem" "position" 2 "name" "Exhibitions" "item" (absURL "work/"))
      (dict "@type" "ListItem" "position" 3 "name" .Title        "item" .Permalink)
    )
  -}}
  
  {{- /* Emit JSON-LD WITHOUT extra quotes */ -}}
  {{- dict
    "@context" "https://schema.org"
    "@graph"   (slice $page $event $person | append $imgNodes | append $breadcrumbs)
    | jsonify | safeHTML -}}
  </script>
  

<div class="container">
  <div class="exhb-hero" id="hero-content"></div>

  <script>
    function isMobileDevice(){ return /Mobi|Android/i.test(navigator.userAgent); }
    function isVideoSupported(){ var v=document.createElement('video'); return !!v.canPlayType; }
    function insertHeroContent(){
      var el=document.getElementById('hero-content');
      var baseURL="{{ .Page.RelPermalink }}";
      function normalizeURL(u){ var p=u.split('/'); if(p[1]==='bg'){ p.splice(1,1);} return p.join('/'); }
      baseURL=normalizeURL(baseURL);
      if(isMobileDevice()){
        el.innerHTML='<img src="'+baseURL+'/hero.webp" alt="Hero Image" class="featured-image">';
      }else if(isVideoSupported()){
        el.innerHTML='<video autoplay muted loop class="featured-video" poster="'+baseURL+'/hero.webp"><source src="'+baseURL+'/hero.webm" type="video/webm"></video>';
      }else{
        el.innerHTML='<img src="'+baseURL+'/hero.webp" alt="Hero Image" class="featured-image">';
      }
    }
    window.addEventListener('DOMContentLoaded', insertHeroContent);
  </script>

  <div class="exhb-title">
    <h1>{{ .Title }}</h1>
    <div class="placedate">
      {{- $place := .Params.place -}}
      {{- $location := .Params.location -}}
      {{- if and $place $location -}}<p>{{ $place }}, {{ $location }}</p>
      {{- else if $place -}}<p>{{ $place }}</p>
      {{- else if $location -}}<p>{{ $location }}</p>{{- end -}}
      {{ $startDate := .Params.datestart | default "1970-01-01T00:00:00+00:00" | time.AsTime }}
      {{ $endDate   := .Params.dateend   | default "1970-01-01T00:00:00+00:00" | time.AsTime }}
      {{ printf "%s-%s" ($startDate | time.Format "02.01") ($endDate | time.Format "02.01.2006") }}
    </div>
  </div>

  <div class="exhb-medium">
    {{ with .Params.medium }}
      <p class="medium-text">{{ range . }}{{ . }}<br>{{ end }}</p>
    {{ end }}
  </div>

  <div class="exhb-people">
    <div class="people">
      <div class="collaborators">
        {{ with .Params.collaborators }}
          <p>{{ i18n "Collaborators" }}<br>{{ range . }}{{ . }}<br>{{ end }}</p>
        {{ end }}
      </div>
      {{ with .Params.curator }}
        <p>{{ i18n "Curator" }}<br>{{ range . }}{{ . }}<br>{{ end }}</p>
      {{ end }}
      {{ with .Params.sound }}
        <p>{{ i18n "Sound" }}<br>{{ range . }}{{ . }}<br>{{ end }}</p>
      {{ end }}
      {{ with .Params.photo }}
        <p>{{ i18n "Photo" }}<br>{{ range . }}{{ . }}<br>{{ end }}</p>
      {{ end }}
    </div>
  </div>

  <div class="exhb-body">
    <div class="exhb-text">{{ .Content }}</div>

    {{ if gt (len $critFor) 0 }}
    <section>
      <h2>{{ T "critique" | default (cond $isBG "Критика" "Critique") }}</h2>
      {{ range $c := $critFor }}
        {{ $title := cond $isBG (or $c.namebg $c.nameen) (or $c.nameen $c.namebg) }}
        {{ $desc  := cond $isBG (or $c.descriptionbg $c.descriptionen) (or $c.descriptionen $c.descriptionbg) }}
        {{ $auth  := cond $isBG (or $c.authorbg $c.authoren) (or $c.authoren $c.authorbg) }}
        <a href="{{ $c.url }}" target="_blank" rel="noopener">{{ $title }}</a>{{ with $auth }} - {{ . }}{{ end }}
        {{ with $desc }}<div>{{ . }}</div>{{ end }}
      {{ end }}
    </section>
    {{ end }}

    {{ if gt (len $pressFor) 0 }}
    <section>
      <h2>{{ T "press" | default (cond $isBG "Медийно покритие" "Press") }}</h2>
      <p>
        {{ $links := slice }}
        {{ range $p := $pressFor }}
          {{ $label := cond $isBG (or $p.namebg $p.nameen) (or $p.nameen $p.namebg) }}
          {{ $links = $links | append (printf `<a href="%s" target="_blank" rel="noopener">%s</a>` $p.url $label) }}
        {{ end }}
        {{ delimit $links ", " | safeHTML }}
      </p>
    </section>
    {{ end }}

    {{/* --- Gallery (captions only in lightbox) --- */}}
    <div id="my-gallery" class="masonry-grid">
      {{ range $index, $resource := $resources }}
        {{ $title := index $.Params.imgNames $index | default "" }}
        {{ $description := index $.Params.imgDescrps $index | default "" }}
        {{ if and (in $resource.MediaType.Type "image") (ne $resource.Name "hero.webp") }}
          {{ $thumb := $resource.Resize "420x" }}
          {{ $large := $resource.Resize "1600x" }}

          <a
            class="spotlight"
            href="{{ $large.RelPermalink }}"
            data-pswp-width="{{ $large.Width }}"
            data-pswp-height="{{ $large.Height }}"
            data-pswp-title="{{ $title }}"
            data-pswp-desc="{{ $description }}"
            aria-label="{{ $title }}"
          >
            <img
              src="{{ $thumb.RelPermalink }}"
              alt="{{ $title }}"
              title="{{ $description }}"
              class="gallery-image"
              loading="lazy"
            />
          </a>
        {{ end }}
      {{ end }}
    </div>
  </div>
</div>

<script type="module">
  import PhotoSwipeLightbox from "/js/photoswipe-lightbox.esm.js";
  const lightbox = new PhotoSwipeLightbox({
    gallery: "#my-gallery",
    children: "a.spotlight",
    pswpModule: () => import("/js/photoswipe.esm.js"),
    wheelToZoom: true, pinchToClose: true, closeOnVerticalDrag: true, allowPanToNext: true,
    imageClickAction: 'zoom-or-close', doubleTapAction: 'zoom', tapAction: 'toggle-controls', bgClickAction: 'close',
    initialZoomLevel: 'fit', secondaryZoomLevel: 1.5, maxZoomLevel: 3,
    paddingFn: (vp) => { const pad = vp.x < 860 ? 12 : 24; return { top: pad, right: pad, bottom: pad, left: pad }; }
  });
  lightbox.on('uiRegister', function() {
    lightbox.pswp.ui.registerElement({
      name: 'caption', order: 9, isButton: false, className: 'pswp__ndg-caption', appendTo: 'root',
      html: `<div class="pswp__ndg-caption__inner"><div class="pswp__ndg-caption__title"></div><div class="pswp__ndg-caption__desc"></div></div>`,
      onInit: (el, pswp) => {
        const $title = el.querySelector('.pswp__ndg-caption__title');
        const $desc  = el.querySelector('.pswp__ndg-caption__desc');
        const update = () => {
          const s = pswp.currSlide; let t='', d='';
          if (s && s.data && s.data.element) { const a = s.data.element;
            t = a.getAttribute('data-pswp-title') || ''; d = a.getAttribute('data-pswp-desc') || ''; }
          $title.textContent = t; $desc.textContent = d; el.style.display = (t || d) ? 'flex' : 'none';
        };
        pswp.on('afterInit', update); pswp.on('change', update);
      }
    });
  });
  lightbox.init();
</script>

{{ end }}
